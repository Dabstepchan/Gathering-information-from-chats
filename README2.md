# Проект: Telegram-бот на Laravel для сбора хештегов из клиентских чатов с формированием отчета по заданным параметрам.

## Пользовательские файлы проекта:

### 1. Laravel команды:
1.1. **CheckHashtagReports.php**  
Проверяет наличие определенных хештегов в сообщениях Telegram-чатов за заданный период и создает таблицу в Google Sheets, отправляя пользователю-администратору отчет в Telegram при отсутствии сообщений с указанными хештегами;

1.2. **CheckSchedule.php**  
Проверяет, совпадает ли текущее время с временем, заданным администратором в настройках, и запускает команду, описанную выше (reports:check) при совпадении.

### 2. Обработчик сообщений:
2.1. **Handler.php**  
Обработчик сообщений. В данном файле реализовано меню с кнопками в Telegram-чате для управления параметрами отчета.

### 3. Модели Eloquent:
3.1. **BotSettings.php**  
Модель для взаимодействия с таблицей bot_settings. Содержит настройки бота (день/время отчета, период (в неделях), хештеги);

3.2. **TelegraphMessage.php**  
Модель для взаимодействия с таблицей telegraph_messages. Содержит текст сообщений из чатов и дату отправки в формате datetime.

### 4. Сервис-провайдеры:
4.1. **GoogleServiceProvider.php**  
Сервис-провайдер для регистрации экземпляра класса Sheets для работы с Google Sheets API.

### 5. Миграции:
5.1. **create_telegraph_bots_table.php**  
Миграция для создания таблицы `telegraph_bots` с полями:  
- `id`  
- уникальный `token`  
- необязательное поле `name`  
- стандартные временные метки `created_at` и `updated_at`.

5.2. **create_telegraph_chats_table.php**  
Миграция для создания таблицы `telegraph_chats` с полями:  
- `id`  
- `chat_id`  
- необязательное поле `name`  
- внешний ключ `telegraph_bot_id`, связанный с таблицей `telegraph_bots` (с каскадным удалением).  
Добавлено уникальное ограничение на сочетание `chat_id` и `telegraph_bot_id`, а также стандартные временные метки `created_at` и `updated_at`.

5.3. **create_telegraph_messages.php**  
Миграция для создания таблицы `telegraph_messages` с полями:  
- `id`  
- внешний ключ `telegraph_chat_id`, связанный с таблицей `telegraph_chats` (с каскадным удалением)  
- текстовое поле `message`  
- метка времени `sent_at`  
- стандартные временные метки `created_at` и `updated_at`.

5.4. **create_bot_settings_table.php**  
Миграция для создания таблицы `bot_settings` с полями:  
- `id`  
- строковое поле `report_day` (значение по умолчанию "Понедельник")  
- время `report_time` (по умолчанию "10:00:00")  
- целое поле `period_weeks` (по умолчанию 1)  
- поле `hashtags` формата JSON (может быть пустым).  
Добавлены стандартные временные метки `created_at` и `updated_at`.

---

## Технологии и инструменты разработки:

1. **PHP** — серверный язык программирования;  
2. **Laravel** — PHP-фреймворк с инструментами для маршрутизации, ORM и безопасности;  
3. **MySQL** — реляционная база данных;
4. **Ngrok** — проброс локального сервера в интернет с созданием публичного URL.  
5. **Apache** — веб-сервер для обработки HTTP-запросов;
6. **Open Server** — локальный сервер для Windows (включает PHP, MySQL, Apache).

---

## Библиотеки:

1. **Telegraph**  
Библиотека для Laravel, предназначенная для упрощенного взаимодействия с Telegram Bot API. Позволяет писать простые запросы, т.к. библиотека берет на себя всю рутинную работу по формированию и отправке HTTP запросов, проверке ответов и обработке ошибок. При работе с библиотекой, разработчику не требуется взаимодействовать с curl напрямую;

2. **Google**  
Библиотека, которая используется для работы с Google Sheets. С помощью использования этой библиотеки разработчик избегает ручной обработки OAuth2 аутентификации;

3. **Revolution\Google**  
Библиотека, которая упрощает работу с Google Sheets, предоставляя методы для работы с таблицами, такими как get(), all(), append(), update(), и другие;

4. **Carbon**  
Библиотека, которая упрощает работу с датами. При использовании встроенной библиотеки PHP DateTime код становится менее читаемым;

5. **Command**  
Библиотека, предназначенная для создания команд;

6. **Illuminate\Support\Stringable**  
Используется для работы со строками;

### Eloquent ORM:
Отдельно стоит упомянуть Eloquent ORM – встроенную в Laravel ORM, предоставляющую разработчикам взаимодействие с таблицами БД как с объектами. Таким образом, Eloquent ORM упрощает CRUD-операции (создание, чтение, обновление и удаление данных). 

---

## Основные возможности:
Все представленные возможности реализованы согласно ТЗ. По умолчанию, каждый понедельник в 10:00 бот проверяет наличие тегов `#митрепорт` и `#еженедельныйотчет` в чатах за неделю (т.е. с предыдущего понедельника по текущий). При отсутствии в какого-либо тега в хештега в одном из чатов, бот отправляет администратору отчет в личные сообщения, в которых указывается заголовок отчета, ссылка на чат и google таблицу. Каждому хештегу соответствует свой заголовок отчета. Столбцы таблицы: период, хештег, чат и ссылка на чат. Для каждого периода бот создает новый лист с датами периода в таблице.
## Админ-панель бота (2 итерация)

Согласно 2 итерации, была реализована админ-панель, которая представляет собой меню в личных сообщениях бота. Через эту панель можно:

### 1. Отправить отчет в моменте
- В этом случае будет использоваться заданный в настройках период в неделях, но использоваться текущий день недели и текущее время.

### 2. Задать параметры
#### 2.1. День недели, когда собирать отчет
- От него будет отталкиваться и период сбора по дням недели.

#### 2.2. Время сбора отчета
- Из этого параметра будет вычисляться время периода сбора:  
  `ВремяНачала = ВремяСбораОтчета`,  
  `ВремяОкончания = ВремяСбораОтчета - 1 секунда`.

#### 2.3. Количество недель в периоде
- Задается количество недель в периоде.

#### 2.4. Хештеги, которые следует искать
- Пара полей:  
  - **Хештег** — хештег, который следует искать.  
  - **Заголовок отчета** — заголовок отчета.

### 3. Посмотреть описание бота
- Позволяет ознакомиться с описанием функционала бота.